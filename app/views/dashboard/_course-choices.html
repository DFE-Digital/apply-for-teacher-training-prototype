{% for item in choices %}

  {% set canRespond = item.status == "Offer received" %}

  {% set hasResponded =
    (item.status == "Conditions not met")
    or (item.status == "Offer confirmed")
    or (item.status == "Offer declined")
    or (item.status == "Unsuccessful")
    or (item.status == "Offer withdrawn")
    or (item.status == "Application withdrawn")
    or (item.status == "Application cancelled")
  %}

  {% set canWithdraw =
    (item.status != "Offer received")
    and (item.status != "Offer declined")
    and (item.status != "Application not sent")
    and (item.status != "Unsuccessful")
    and (item.status != "Offer withdrawn")
    and (item.status != "Application withdrawn")
    and (item.status != "Conditions not met")
  %}

  {% set statusHtml %}
    {{ govukTag({
      classes: item.status | statusClass,
      text: item.status
    }) }}

    {% if item.status == "Awaiting decision" %}
      <p class="govuk-body govuk-!-margin-top-2">The provider must make a decision by  {{ 14 | nowPlusDays("d MMMM yyyy") }}.</p>
    {% endif %}

    {% if item.status == "Application withdrawn" and item.withdrawnByProvider == true %}
      <p class="govuk-body govuk-!-margin-top-2">The provider withdrew the application at your request.</p>

      <p class="govuk-body">If you did not request this, email <a class="govuk-link" href="mailto:becomingateacher@digital.education.gov.uk">becomingateacher@digital.education.gov.uk</a>.</p>
    {% endif %}

    {% if item.offeredCourseId %}

      {% if item.offeredProviderId %}
        {% set offeredCourse = providers[item.offeredProviderId].courses[item.offeredCourseId] %}
      {% else %}
        {% set offeredCourse = providers[item.providerCode].courses[item.offeredCourseId] %}
      {% endif %}

      {% if item.offeredProviderId != item.providerId %}
        <p class="govuk-body govuk-!-margin-top-2">You have been offered a place on a different course from another provider:</p>
      {% else %}
        <p class="govuk-body govuk-!-margin-top-2">You have been offered a place on a different course from the one you applied to:</p>
      {% endif %}

      {% set courseOfferedDescription %}

        {% if item.offeredProviderId != item.providerId %}
          <b>{{ providers[item.offeredProviderId].name }}</b><br>
        {% endif %}

        <a href="#">{{ offeredCourse.name }} ({{ item.offeredCourseId }})</a>
        <br>{{ offeredCourse.description }}<br>{{  offeredCourse.locations[0].name }}
      {% endset %}

      {{ govukInsetText({
        html: courseOfferedDescription,
        classes: "govuk-!-padding-top-0 govuk-!-padding-bottom-0 govuk-!-margin-top-0"
      }) }}
    {% endif %}

  {% endset %}

  {% set interviewHtml %}
    {% if item.interview %}
      {% for interview in item.interview %}
        {% if (interview.date | date) > ("" | dateNow() | date) %}
          <p class="govuk-body">You have an interview scheduled for {{ interview.date | date("d LLLL yyyy, h:mma") }}</p>

          <p class="govuk-body govuk-!-margin-bottom-0">Information from provider:</p>

          {% set interviewDetails %}
            <p class="govuk-body">{{ interview.address | safe }}</p>

            {% if interview.additional_details %}
              <p class="govuk-body">{{ interview.additional_details | safe }}</p>
            {% endif %}
          {% endset %}

          {{ govukInsetText({
            html: interviewDetails,
            classes: "govuk-!-margin-top-1 govuk-!-margin-bottom-1"
          }) }}

          <p class="govuk-body">The provider will send more details about the interview by email.</p>

        {% else %}
          <p class="govuk-body">You had an interview on {{ interview.date | date("d LLLL yyyy") }}</p>
        {% endif %}
      {% endfor %}
    {% else %}
      The provider will be in touch if they want to invite you to an interview.
    {% endif %}
  {% endset %}

  {% set feedbackHtml %}{% include "_includes/item/feedback.html" %}{% endset %}

  {% set conditionsHtml %}
    {% if item.conditions | length > 0 %}
        <ul class="govuk-list govuk-list--bullet">
        {% for condition in item.conditions %}
          <li>{{ condition.title }}</li>
        {% endfor %}
      </ul>
      <p class="govuk-body">Contact the provider to find out more about these conditions.</p>
      <p class="govuk-body">They’ll confirm your place once you’ve met the conditions and they’ve checked your references.</p>
    {% else %}
      <p class="govuk-body">Contact the provider to find out more about any conditions.</p>
      <p class="govuk-body">They’ll confirm your place once you’ve met any conditions and they’ve checked your references.</p>

    {% endif %}
  {% endset %}

  {% set actionsHtml %}
    {% if canWithdraw %}
      <p class="govuk-body"><a href="{{ applicationPath + "/" + item.id + "/withdraw" }}">Withdraw this application</a></p>
    {% endif %}
    {% if canRespond and not hasResponded %}
      <p class="govuk-body"><a href="{{ applicationPath + "/" + item.id + "/view" }}">Respond to offer</a></p>

      <p class="govuk-body">
        {% if numberOfChoicesAwaitingDecision > 0 %}
          You can wait to hear back from everyone before you respond.
        {% else %}
          You have 14 days (until 12 December 2022) to respond.
        {% endif %}
      </p>
    {% endif %}
  {% endset %}

  {% set summaryHeaderHtml %}
    <span class="app-course-choice__provider-name">{{ providers[item.providerCode]["name"] }}</span>
    <span class="app-course-choice__course-name">{{ providers[item.providerCode].courses[item.courseCode].name_and_code }}</span>
  {% endset %}

  {% set skeHtml %}
    <p class="govuk-body">If you accept this offer, you’ll need to do a 20&nbsp;week maths course.  This is to help you improve your subject knowledge because your degree subject was not in maths.</p>

    <p class="govuk-body">You should complete the course before your teacher training starts in September 2023.</p>

    <p class="govuk-body">The course will be free and you’ll receive £175 per week. How and when this is paid will depend on your provider.</p>

    <p class="govuk-body">You can choose how you study your course. Courses can be:</p>

    <ul class="govuk-list govuk-list--bullet">
      <li>full time (about 25 hours of studying a week)</li>
      <li>part time (the course might take longer than 20 weeks if it's part time)</li>
      <li>online, in person, or a mixture of both</li>
    </ul>

  {% endset %}

  {% set summaryBodyHtml %}
    {{ govukSummaryList({
      classes: "govuk-!-margin-bottom-0",
      rows: [{
        key: {
          text: "Status"
        },
        value: {
          html: statusHtml | safe
        }
      }, {
        key: {
          text: "Interview"
        },
        value: {
          html: interviewHtml | safe
        }
      } if item.status == "Awaiting decision", {
        key: {
          text: "Feedback"
        },
        value: {
          html: feedbackHtml | safe
        }
      } if item.feedback,
      {
          key: {
            text: "Subject knowledge enhancement course"
          },
          value: {
            html: skeHtml
          }
        }, {
        key: {
          text: "Conditions"
        },
        value: {
          html: conditionsHtml | safe
        }
      } if item.status != 'Awaiting decision', {
        key: {
          classes: "govuk-visually-hidden",
          text: "Actions"
        },
        value: {
          html: actionsHtml | safe
        }
      } if canAmend or canWithdraw or canRespond]
    }) }}
  {% endset %}


  {{ appSummaryCard({
    classes: "app-course-choice govuk-!-margin-bottom-6",
    titleHtml: summaryHeaderHtml,
    actions: {
      items: [{
        href: applicationPath + "/submitted/?referrer=" + referrer,
        text: "View application"
      }]
    },
    html: summaryBodyHtml
  }) }}

{% endfor %}
